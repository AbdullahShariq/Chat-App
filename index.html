<!DOCTYPE html>
<html>
<head>
    <title>Chat App</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
        input { margin: 5px 0; display: block; padding: 8px; }
    </style>
</head>
<body>
<div class="section">
  <h3>Step 1: Create a New User</h3>
  <input id="regUser" placeholder="Username" />
  <input id="regEmail" placeholder="Email" />
  <input id="regPassword" type="password" placeholder="Password" /> 
  <button onclick="register()">Create User</button>
</div>

  <div class="section">
    <h3>Step 2: Chat by Username</h3>
    <input id="senderName" placeholder="Your Username" />
    <input id="receiverName" placeholder="Receiver Username" />
    <input id="msg" placeholder="Message" />
    <button onclick="sendMessage()">Send Message</button>
  </div>

  <div class="section" style="background: #eef;">
    <h3>Step 3: Rooms (Group Chat)</h3>
    <input id="roomName" placeholder="Room Name (e.g., Coding)" />
    <button onclick="joinRoom()">Join Room</button>
    <br>
    <input id="roomMsg" placeholder="Message to Room" />
    <button onclick="sendToRoom()">Send to Room</button>
</div>


  <ul id="messages"></ul>

  <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
  <script>
    const socket = io("http://localhost:3000");

    // Handle incoming messages
    socket.on("newMessage", (msg) => {
      const li = document.createElement("li");
      li.textContent = `${msg.sender.username}: ${msg.text}`;
      document.getElementById("messages").appendChild(li);
    });

    socket.on("errorMessage", (err) => alert(err.message));

    // Registration Function
    async function register() {
    console.log("Entered reg function");

    // 1. Get the values from the boxes
    const u = document.getElementById("regUser").value;
    const e = document.getElementById("regEmail").value;
    const p = document.getElementById("regPassword").value;

    // 2. Simple check
    if (!u || !e || !p) {
        alert("Please fill all three boxes!");
        return;
    }

    try {
        console.log(" fetching now ");

        // 3. Send the data to the server
        const response = await fetch("http://127.0.0.1:3000/users", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                username: u, 
                email: e, 
                password: p 
            })
        });
        console.log(" fetching worked perfectly ");

        const result = await response.json();

        if (response.ok) {
            alert("User created: " + result.username);
            // Clear the boxes
            document.getElementById("regUser").value = "";
            document.getElementById("regEmail").value = "";
            document.getElementById("regPassword").value = "";
        } else {
            alert("Error: " + result.message);
        }
    } catch (err) {
        console.error(err);
        alert("Could not connect to server. Is your terminal running?");
    }
}

    // Send Message Function
    function sendMessage() {
      const senderName = document.getElementById("senderName").value;
      const receiverName = document.getElementById("receiverName").value;
      const text = document.getElementById("msg").value;
      socket.emit("sendMessage", { senderName, receiverName, text });
    }

    // Add these new functions at the bottom of your script
function joinRoom() {
    const room = document.getElementById("roomName").value;
    socket.emit("joinRoom", room);
    alert("You joined room: " + room);
}

function sendToRoom() {
    const roomName = document.getElementById("roomName").value;
    const senderName = document.getElementById("senderName").value; // Reuse senderName from Step 2
    const text = document.getElementById("roomMsg").value;
    socket.emit("sendToRoom", { roomName, senderName, text });
}


// Add this to listen for the broadast notification
socket.on("notification", (note) => {
    console.log("Global Notification:", note);
});
  </script>
</body>
</html>
